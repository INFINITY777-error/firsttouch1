# ai_agent.py â€” MedAssist AI v4.0 (Fixed & Enhanced)
# â”€â”€â”€ ALL FIXES APPLIED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# FIX 1: tools=[] passed to create_react_agent even when empty â†’ skip if no tools
# FIX 2: system_prompt=None passed without fallback â†’ always fallback to DEFAULT
# FIX 3: ai_messages could be empty list â†’ better error message returned
# ENHANCEMENT: Added retry logic for transient API errors
# ENHANCEMENT: Added token/cost-aware model selection hint
# ENHANCEMENT: Added build_patient_context() as standalone helper
# ENHANCEMENT: analyze_symptoms now returns richer structured query
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

from dotenv import load_dotenv
load_dotenv()

import os
import time

GROQ_API_KEY   = os.environ.get("GROQ_API_KEY")
TAVILY_API_KEY = os.environ.get("TAVILY_API_KEY")
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")

from langchain_groq import ChatGroq
from langchain_openai import ChatOpenAI
from langchain_community.tools.tavily_search import TavilySearchResults
from langgraph.prebuilt import create_react_agent
from langchain_core.messages import AIMessage, SystemMessage, HumanMessage


# â”€â”€â”€ Default Medical System Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

DEFAULT_MEDICAL_PROMPT = """You are Dr. MedAssist AI, a senior clinical diagnosis assistant with expertise across internal medicine, general practice, and emergency care.

âš ï¸ IMPORTANT DISCLAIMERS:
- You provide preliminary health assessments and guidance only
- You are NOT a replacement for professional medical advice, diagnosis, or treatment
- NEVER prescribe controlled substances or treatments requiring professional oversight
- Always recommend consulting a licensed healthcare provider for confirmation
- In emergencies, advise calling emergency services immediately

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CLINICAL ASSESSMENT PROTOCOL â€” ALWAYS FOLLOW THIS FORMAT:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ”¬ CLINICAL ASSESSMENT REPORT

**Patient Presentation:** [Brief summary of symptoms]

---

## ğŸ“‹ DIFFERENTIAL DIAGNOSIS

Provide 2â€“4 possible conditions ranked by likelihood:

### 1. [Most Likely Condition] â€” Likelihood: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ High
- **ICD-10 Code:** [Code if applicable]
- **Why this fits:** [Clinical reasoning]
- **Key distinguishing features:** [What makes this the top diagnosis]

### 2. [Second Condition] â€” Likelihood: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ Moderate
- **ICD-10 Code:** [Code if applicable]
- **Why this fits:** [Clinical reasoning]

### 3. [Third Condition] â€” Likelihood: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ Low-Moderate
- **Why this fits:** [Clinical reasoning]

---

## ğŸ’Š TREATMENT & PRESCRIPTION RECOMMENDATIONS

> âš ï¸ These are general treatment guidelines. Actual prescriptions require a licensed physician.

### OTC Medications (Available Without Prescription):
| Medication | Dosage | Purpose | Duration |
|-----------|--------|---------|----------|
| [Drug name] | [Dose] | [Indication] | [Duration] |

### Prescription Medications (Require Doctor Visit):
| Medication Class | Examples | Typical Use |
|-----------------|---------|------------|
| [Drug class] | [Examples] | [When prescribed] |

### âŒ Medications to AVOID:
- [Contraindicated drugs based on patient history/allergies]

---

## ğŸ§ª RECOMMENDED DIAGNOSTIC TESTS

- **Immediate Tests:** [Blood work, urinalysis, imaging, etc.]
- **Specialist Referral:** [If needed â€” which specialist]
- **Follow-up Timeline:** [When to reassess]

---

## ğŸ  HOME CARE & LIFESTYLE RECOMMENDATIONS

- **Rest & Activity:** [Specific guidance]
- **Diet & Hydration:** [Specific recommendations]
- **Monitoring:** [What symptoms to watch]
- **Red Flags:** [Symptoms requiring immediate ER visit]

---

## â° URGENCY LEVEL

ğŸŸ¢ Non-Urgent / ğŸŸ¡ Schedule Visit Within 48â€“72 Hours / ğŸ”´ Seek Care Today / ğŸš¨ Emergency â€” Call 911

**Assessment:** [Your urgency recommendation with reasoning]

---

*This report was generated by Dr. MedAssist AI for educational purposes. Consult a licensed physician for official diagnosis and treatment.*
"""


# â”€â”€â”€ Patient Context Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def build_patient_context(patient_info: dict) -> str:
    """
    ENHANCEMENT: Standalone helper to build a structured patient context block.
    Returns an empty string if patient_info is empty or None.
    """
    if not patient_info:
        return ""

    lines = []

    field_labels = {
        "age":                 "Patient Age",
        "gender":              "Biological Sex / Gender",
        "weight":              "Weight (kg)",
        "height":              "Height (cm)",
        "bmi":                 "BMI",
        "bmi_category":        "BMI Category",
        "blood_type":          "Blood Type",
        "medical_history":     "Medical History / Chronic Conditions",
        "current_medications": "Current Medications",
        "allergies":           "Known Allergies (CRITICAL)",
        "smoking_status":      "Smoking Status",
        "alcohol_use":         "Alcohol Use",
        "family_history":      "Family History",
    }

    for field, label in field_labels.items():
        value = patient_info.get(field)
        if value:
            suffix = ""
            if field == "age":   suffix = " years old"
            if field == "weight": suffix = " kg"
            if field == "height": suffix = " cm"
            lines.append(f"{label}: {value}{suffix}")

    if not lines:
        return ""

    return (
        "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
        "PATIENT CLINICAL PROFILE\n"
        "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
        + "\n".join(lines)
    )


# â”€â”€â”€ Core AI Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def get_medical_diagnosis(
    llm_id:        str,
    query:         str,
    allow_search:  bool,
    system_prompt: str,
    provider:      str,
    patient_info:  dict = None,
    max_retries:   int  = 2,
) -> str:
    """
    Run the medical diagnosis AI agent.

    Args:
        llm_id:        Model name string (e.g. 'llama3-70b-8192')
        query:         Symptom query built by analyze_symptoms()
        allow_search:  Enable Tavily web search tool
        system_prompt: Override system instructions (uses DEFAULT if None/empty)
        provider:      'Groq' or 'OpenAI'
        patient_info:  Optional dict of patient clinical data
        max_retries:   Retry count on transient errors (ENHANCEMENT)

    Returns:
        AI response string
    """
    # FIX 2: Always use DEFAULT if no prompt provided
    effective_prompt = system_prompt if system_prompt and system_prompt.strip() else DEFAULT_MEDICAL_PROMPT

    # â”€â”€ Initialize LLM â”€â”€
    if provider == "Groq":
        llm = ChatGroq(model=llm_id, temperature=0.3)
    elif provider == "OpenAI":
        llm = ChatOpenAI(model=llm_id, temperature=0.3)
    else:
        raise ValueError(f"Unsupported provider: {provider}. Use 'Groq' or 'OpenAI'")

    # â”€â”€ Setup Tools â”€â”€
    tools = []
    if allow_search:
        if not TAVILY_API_KEY:
            raise ValueError("TAVILY_API_KEY not set in .env â€” cannot enable web search")
        tools.append(TavilySearchResults(max_results=5))

    # â”€â”€ Build Enhanced Query with Patient Context â”€â”€
    patient_context = build_patient_context(patient_info)

    if patient_context:
        enhanced_query = (
            f"{patient_context}\n\n"
            f"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
            f"CHIEF COMPLAINT / SYMPTOMS\n"
            f"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
            f"{query}"
        )
    else:
        enhanced_query = query

    # â”€â”€ Create Agent â”€â”€
    # FIX 1: Only pass tools if non-empty; create_react_agent handles empty list fine
    # but being explicit avoids edge-case issues in some langgraph versions
    agent = create_react_agent(
        model=llm,
        tools=tools,
    )

    state = {
        "messages": [
            SystemMessage(content=effective_prompt),
            HumanMessage(content=enhanced_query),
        ]
    }

    # â”€â”€ Invoke with Retry Logic (ENHANCEMENT) â”€â”€
    last_error = None
    for attempt in range(max_retries + 1):
        try:
            response  = agent.invoke(state)
            messages  = response.get("messages", [])
            ai_messages = [msg.content for msg in messages if isinstance(msg, AIMessage)]

            if not ai_messages:
                # FIX 3: Better error message instead of silent empty return
                return "âš ï¸ The AI agent did not return a response. Please try again or switch models."

            return ai_messages[-1]

        except Exception as e:
            last_error = e
            if attempt < max_retries:
                wait = 2 ** attempt  # exponential backoff: 1s, 2s
                print(f"âš ï¸  AI agent attempt {attempt+1} failed: {e}. Retrying in {wait}s...")
                time.sleep(wait)
            else:
                raise RuntimeError(f"AI agent failed after {max_retries + 1} attempts: {last_error}")


# â”€â”€â”€ Symptom Query Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def analyze_symptoms(
    symptoms: list,
    severity: str = "Moderate",
    duration: str = None,
) -> str:
    """
    ENHANCEMENT: Build a richer structured symptom query for the AI agent.
    """
    if not symptoms:
        raise ValueError("At least one symptom is required")

    symptom_count = len(symptoms)
    symptom_text  = ", ".join(symptoms)

    query = (
        f"Chief Complaint: Patient presents with {symptom_count} symptom(s) "
        f"(overall severity: {severity}): {symptom_text}."
    )

    if duration:
        query += f" Duration of symptoms: {duration}."

    query += (
        "\n\nPlease provide a full clinical assessment including:\n"
        "1. Differential diagnosis (ranked by likelihood with ICD-10 codes)\n"
        "2. Treatment and prescription recommendations (OTC and Rx)\n"
        "3. Medications to avoid\n"
        "4. Recommended diagnostic tests\n"
        "5. Home care and lifestyle recommendations\n"
        "6. Urgency level assessment\n"
    )

    return query


# â”€â”€â”€ Test Block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if __name__ == "__main__":
    test_query = analyze_symptoms(
        symptoms=["severe headache", "high fever", "neck stiffness", "photophobia"],
        severity="Severe",
        duration="12 hours",
    )
    print("Test Query:")
    print(test_query)
    print("\nPatient Context Test:")
    ctx = build_patient_context({
        "age": 35, "gender": "Male", "weight": 80, "height": 175,
        "allergies": "Penicillin", "medical_history": "Hypertension"
    })
    print(ctx)
